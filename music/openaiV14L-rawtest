const { Client, Intents } = require('discord.js');
const { joinVoiceChannel, createAudioPlayer, createAudioResource, StreamType, AudioPlayerStatus, VoiceConnectionStatus } = require('@discordjs/voice');
const ytdl = require('ytdl-core');
const { OpusEncoder } = require('@discordjs/opus');

const client = new Client({ intents: [Intents.FLAGS.GUILDS, Intents.FLAGS.GUILD_MESSAGES, Intents.FLAGS.GUILD_VOICE_STATES] });
const prefix = '!'; // Change this to your desired command prefix

client.once('ready', () => {
  console.log('Ready!');
});

client.on('messageCreate', async message => {
  if (!message.content.startsWith(prefix) || message.author.bot) return;
  const args = message.content.slice(prefix.length).trim().split(/ +/);
  const command = args.shift().toLowerCase();

  if (command === 'play') {
    if (!message.member.voice.channel) return message.reply('You need to be in a voice channel!');
    if (!args.length) return message.reply('You need to provide a URL or a search query!');
    
    const connection = joinVoiceChannel({
      channelId: message.member.voice.channel.id,
      guildId: message.guild.id,
      adapterCreator: message.guild.voiceAdapterCreator
    });

    connection.on(VoiceConnectionStatus.Disconnected, () => {
      message.reply('Disconnected from the voice channel!');
    });

    const player = createAudioPlayer();
    connection.subscribe(player);

    const stream = ytdl(args[0], { filter: 'audioonly' });
    const opusEncoder = new OpusEncoder(48000, 2);
    const resource = createAudioResource(stream, { inputType: StreamType.Arbitrary, inlineVolume: true });
    resource.pipe(opusEncoder).on('data', (packet) => {
      player.sendPacket(packet);
    });

    let audioResource = resource; // Keep a reference to the audio resource
    player.on(AudioPlayerStatus.Idle, () => {
      connection.destroy();
      audioResource?.metadata?.onDestroy(); // Cleanup the audio resource to prevent memory leaks
      audioResource = null;
    });

    message.reply(`Now playing: ${stream.videoDetails.title}`);
  }

  if (command === 'stop') {
    if (!message.member.voice.channel) return message.reply('You need to be in a voice channel to stop the music!');
    const connection = client.voice.connections.get(message.guild.id);
    if (!connection) return message.reply('The bot is not currently playing any music!');
    connection.destroy();
    message.reply('Stopped the music!');
  }
});

client.login('your-bot-token');
